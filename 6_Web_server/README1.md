Давайте создадим веб -сервер.Часть 1
============================================================================================================================



Однажды на прогулке женщина наткнулась на строительную площадку и увидела, как работают трое мужчин.Она спросила первого мужчину: «Что ты делаешь?» Раздраженный вопросом, первый мужик сказал: «Разве ты не видишь, что я кладу кирпичи?»Не удовлетворенная ответом, она спросила второго мужика, что он делает.Второй мужик ответил: «Я строю кирпичную стену».Затем, обращая свое внимание на первого, он сказал: «Эй, ты только что прошел конец стены.Тебе нужно было положить вот этот кирпич ».Снова не удовлетворена ответом, она спросила третьего мужика, что он делает.И мужчина сказал ей, глядя в небо: «Я строю самый большое здание, которое когда -либо знал этот мир».Пока он стоял там и смотрел на небо, два других мужчины начали спорить о ошибочной кладке.Мужчина обратился к первым двум мужчинам и сказал: «Эй, ребята, не беспокойтесь об этой кладке.Это внутренняя стена, она будет замазана, и никто никогда не увидит этого кирпича.Просто перейди к другому слою ».

Мораль этой истории заключается в том, что когда вы знаете всю систему и понимаете, как разные части сочетаются друг с другом (кирпичи, стены, здание), вы можете быстрее определять и решать проблемы (ошибочный кирпич).

Какое это имеет отношение к созданию собственного веб -сервера с нуля?

**Я считаю, что становясь лучшим разработчиком, вы должны лучше понять основные программные системы, которые вы используете ежедневно, и это включает в себя языки программирования, компиляторы и кодировщики, базы данных и операционные системы, веб -серверы и веб -структуры.И, чтобы получить лучшее и более глубокое понимание этих систем, вы должны переработать их с нуля, кирпичик за кирпичиком, стену за стеной.**

Цитата Конфуция: «Я слышу и забываю. Я вижу и запоминаю. Я делаю и понимаю»

> _“Я слышу и забываю”_

![Hear](https://ruslanspivak.com/lsbasi-part4/LSBAWS_confucius_hear.png)

> _“Я вижу и запоминаю.”_

![See](https://ruslanspivak.com/lsbasi-part4/LSBAWS_confucius_see.png)

> _“Я делаю и понимаю.”_

![Do](https://ruslanspivak.com/lsbasi-part4/LSBAWS_confucius_do.png)

Я надеюсь, что на данный момент вы убеждены, что рекомендуется начать повторное строительство различных систем программного обеспечения, чтобы узнать, как они работают.

В этой серии из трех частей я покажу вам, как создать свой собственный базовый веб-сервер.Давайте начнем.

Перво -наперво, что такое веб -сервер?

![HTTP Request/Response](https://ruslanspivak.com/lsbaws-part1/LSBAWS_HTTP_request_response.png)

Короче говоря, это сетевой сервер, который находится на физическом сервере-хосте и ожидает, пока клиент отправит запрос.Когда он получает запрос, он генерирует ответ и отправляет его обратно клиенту.Связь между клиентом и сервером происходит с использованием протокола HTTP.Клиентом может быть вашим браузером или любым другим программным обеспечением, которое говорит HTTP.

Как будет выглядеть очень простая реализация веб -сервера?Вот мой взгляд на это.Пример - в Python (протестирован на Python3.7+), но даже если вы не знаете Python (это очень простой язык, чтобы его попробовать!), Вы все равно должны быть в состоянии понять концепции из кода и объяснений ниже:

```python
# Python3.7+
import socket

HOST, PORT = '', 8888

listen_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
listen_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
listen_socket.bind((HOST, PORT))
listen_socket.listen(1)
print(f'Serving HTTP on port {PORT} ...')
while True:
    client_connection, client_address = listen_socket.accept()
    request_data = client_connection.recv(1024)
    print(request_data.decode('utf-8'))

    http_response = b"""\
HTTP/1.1 200 OK

Hello, World!
"""
    client_connection.sendall(http_response)
    client_connection.close()
```

Сохранить вышеуказанный код как _webserver1.py_ или загрузите его напрямую из [GitHub](https://github.com/rspivak/lsbaws/blob/master/part1/webserver1.py "GitHub") и запустите его на командной строке, вот так 
```
$ python webserver1.py
Serving HTTP on port 8888 …
```
Теперь введите следующий URL в адресной строке вашего веб -браузера [http://localhost:8888/hello](http://localhost:8888/hello "Hello"), Нажмите Enter и посмотрите на магию в действии.Тебе следует увидеть _“Hello, World!”_ отображается в вашем браузере, как здесь:

![Browser "Hello, World!"](https://ruslanspivak.com/lsbaws-part1/browser_hello_world.png)

Просто сделай это, серьезно.Я буду ждать тебя, пока вы его тестируете.

Сделали? Отлично.Теперь давайте обсудим, как все это на самом деле работает.

Сначала давайте начнем с веб -адреса, который вы ввели.Это называется [URL](https://en.wikipedia.org/wiki/Uniform_resource_locator) и вот его основная структура:

![URL Structure](https://ruslanspivak.com/lsbaws-part1/LSBAWS_URL_Web_address.png)

Это то, как вы сообщаете своему браузеру адрес веб -сервера, который он должен найти и подключиться к странице (PATH) на сервере, чтобы получить ответ для вас.Перед тем, как ваш браузер сможет отправить HTTP -запрос, он сначала должен установить соединение TCP с веб -сервером.Затем он отправляет HTTP -запрос через TCP -соединение на сервер и ожидает, что сервер отправит ответ HTTP.И когда ваш браузер получает ответ, он отображает его, в данном случае он отображается “Hello, World!”

Давайте более подробно рассмотрим, как клиент и сервер устанавливают соединение TCP перед отправкой HTTP -запросов и ответов.Для этого они оба используют так называемые _sockets_. Вместо того, чтобы использовать браузер непосредственно, мы собираемся смоделировать ответы нашего браузера вручную, используя _telnet_ в командной строке или putty (telnet)

На том же компьютере, который вы запускаете, веб -сервер запустите сеанс Telnet в командной строке с указанием хоста для подключения к _localhost_ и порту подключиться к _8888_, а затем нажмите Enter:
```
$ telnet localhost 8888
Trying 127.0.0.1 …
Connected to localhost.
```

На этом этапе вы установили соединение TCP с сервером, работающим на вашем локальном хосте, и готовые к отправке и получению HTTP -сообщений.На рисунке ниже вы можете увидеть стандартную процедуру, которую должен пройти сервер, чтобы иметь возможность принимать новые соединения TCP. ![Socket accept](https://ruslanspivak.com/lsbaws-part1/LSBAWS_socket.png)

В том же типе сеанса Telnet введите **_GET /hello HTTP/1.1_** и нажмите Enter:
```
$ telnet localhost 8888
Trying 127.0.0.1 …
Connected to localhost.
GET /hello HTTP/1.1

HTTP/1.1 200 OK
Hello, World!
```

Вы только что смоделировали свой браузер вручную!Вы отправили HTTP -запрос и вернули HTTP -ответ.Это основная структура запроса HTTP:

![HTTP Request Aanatomy](https://ruslanspivak.com/lsbaws-part1/LSBAWS_HTTP_request_anatomy.png)

HTTP -запрос состоит из строки, указывающей метод HTTP (**_GET_**, Потому что мы просим наш сервер вернуть нам что -то), по пути _/hello_ который указывает на расположение_“page”_ страницы на сервере  и версию протокола HTTP.

Для простоты наш веб -сервер на этом этапе полностью игнорирует вышеуказанную строку запроса.Вы можете так же хорошо ввести  любой мусор вместо _“GET /hello HTTP/1.1”_ и вы все равно получите _“Hello, World!”_ .

Как только вы напечатаете строку запроса и нажмали Enter Клиент отправляет запрос на сервер, сервер считывает строку запроса, печатает его и возвращает HTTP-ответ .

Вот ответ HTTP, который сервер отправляет обратно вашему клиенту (_telnet_ в нашем случае): ![HTTP Response Anatomy](https://ruslanspivak.com/lsbaws-part1/LSBAWS_HTTP_response_anatomy.png)

Давайте по-порядку. Ответ состоит из строки статуса _HTTP/1.1 200 OK_, с последующей необходимой пустой строкой, а затем тела ответа HTTP.

Строка состояния ответа _HTTP/1.1 200 OK_ состоит из _HTTP Version_,  _HTTP status code_ = 200 и _HTTP status code reason_ в данном случае равен ОК. Когда браузер получает ответ, он отображает тело ответа, и именно поэтому вы видите _«Hello, World!»_ в вашем браузере.

И это основная модель того, как работает веб -сервер.Подводя итог: веб -сервер создает сокет который слушает и начинает принимать новые подключения в цикле. Клиент инициирует соединение TCP, и, после успешного его создания, клиент отправляет HTTP -запрос на сервер, а сервер отвечает ответом HTTP, который отображается пользователю.Чтобы установить соединение TCP, как клиенты, так и серверы используют _sockets_.

Теперь у вас есть минимальный базовый рабочий веб -сервер, который вы можете проверить вашим браузером или HTTP -клиентом (Postman). Как вы, надеюсь, уже попробовали, вы также можете сэмулировать клиентские HTTP запросы вручную, используя _telnet_ и вводя HTTP -запросы вручную.

Вот вопрос для вас: «Как запустить приложение Django, приложение Flask и приложение Pyramid под вашми свежеиспользованным веб -сервером, не внося ни одного изменения на сервер для размещения всех этих различных веб -структур?»

Мы ознакомимся с этим вопросом во второй части [Part 2](README2.md) 

